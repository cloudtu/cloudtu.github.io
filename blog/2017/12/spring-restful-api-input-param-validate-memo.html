<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
      <meta charset="utf-8" />
      <title>如何在 spring 實作的 restful api 裡使用 validation annotation</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <meta name="description" content="" />
      <meta name="author" content="cloudtu" />
      <meta name="keywords" content="" />

      <!-- Le styles -->
      <link rel="stylesheet" href="/css/bootstrap.min.css" />
      <link rel="stylesheet" href="/css/base.css" />
      <link rel="stylesheet" href="/css/prettify.css" />
  </head>
  <body onload="prettyPrint()">

  <!-- facebook script -->
  <div id="fb-root"></div>
  <script xml:space="preserve">
  //<![CDATA[
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v2.4";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
  //]]>
  </script>

  <div id="wrap">
    <div>

    <!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" shape="rect" href="/index.html">CloudTu's blog</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" shape="rect">Tags<b class="caret"></b></a>
              <ul class="dropdown-menu scrollable-menu">
                <li>
                  <a shape="rect" href="/tags/android.html">android</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/aws.html">aws</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/bitbucket.html">bitbucket</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/cassandra.html">cassandra</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/connection-pool.html">connection-pool</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/eclipse.html">eclipse</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/gae.html">gae</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/git.html">git</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/github.html">github</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/gradle.html">gradle</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/groovy.html">groovy</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/guava.html">guava</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/java.html">java</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/javascript.html">javascript</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/jax-rs.html">jax-rs</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/jbake.html">jbake</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/jersey.html">jersey</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/jetty.html">jetty</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/jquery.html">jquery</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/lambda.html">lambda</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/linux.html">linux</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/mac.html">mac</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/nexus7.html">nexus7</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/notepad-plus-plus.html">notepad-plus-plus</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/oauth2.html">oauth2</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/olap.html">olap</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/python.html">python</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/remote-control.html">remote-control</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/router.html">router</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/selenium.html">selenium</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/spring.html">spring</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/ssh.html">ssh</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/switch.html">switch</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/tomato.html">tomato</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/tomcat.html">tomcat</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/windows7.html">windows7</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/喔~鋼普拉.html">喔~鋼普拉</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/心情記事.html">心情記事</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/敗~敗家啦.html">敗~敗家啦</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/版控系統.html">版控系統</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/程式語言.html">程式語言</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/阿殺不魯.html">阿殺不魯</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/電影、戲劇.html">電影、戲劇</a>
                </li>
              </ul>
            </li>
            <li><a shape="rect" href="/archive.html">Archive</a></li>
            <li><a shape="rect" href="/feed.xml">RSS</a></li>
            <li><a shape="rect" href="/about.html">About</a></li>
          </ul>

          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" shape="rect">Search<b class="caret"></b></a>
              <ul class="dropdown-menu google_search">
                <li>
                  <script xml:space="preserve">
                  //<![CDATA[
                    (function() {
                      var cx = '001738447238955852876:bkori8ynpby';
                      var gcse = document.createElement('script');
                      gcse.type = 'text/javascript';
                      gcse.async = true;
                      gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                          '//cse.google.com/cse.js?cx=' + cx;
                      var s = document.getElementsByTagName('script')[0];
                      s.parentNode.insertBefore(gcse, s);
                    })();
                  //]]>
                  </script>
                  <gcse:searchbox-only></gcse:searchbox-only>
                </li>
              </ul>
            </li>
          </ul>

        </div><!--/.nav-collapse -->
      </div>
    </div>

  </div>
    <div class="container">

      <div class="page-header">
        <h1>如何在 spring 實作的 restful api 裡使用 validation annotation</h1>
      </div>

      <p><em>2017-12-29</em></p>

      <p>
        <em>Tags:
          <span>
            <a shape="rect" href="../../../tags/程式語言.html">程式語言</a>
            <span>,</span>
          </span>
          <span>
            <a shape="rect" href="../../../tags/java.html">java</a>
            <span>,</span>
          </span>
          <span>
            <a shape="rect" href="../../../tags/spring.html">spring</a>
            
          </span>
        </em>
      </p>

      <p><h2>如何實作</h2><p>spring 實作的 restful api，要針對輸入參數進行內容格式驗証，可分成下列儿類</p><h3>針對 @RequestBody 進行 validation</h3><p>實作程式碼重點如下</p>
<!--?prettify linenums=true?-->
<pre><code class="java">@RestController
@RequestMapping(&quot;/validateAnnotationDemo&quot;)
public class ValidateAnnotationDemoController {
    @RequestMapping(value = &quot;/validateRequestBody&quot;, produces = MediaType.APPLICATION_JSON_VALUE)
    public User validateRequestBody(@Valid @RequestBody User user){
        ...etc;
    }

    private static class User{
        @NotBlank
        private String name;
        ...etc;
    }
}
</code></pre>
<!--?prettify linenums=true?-->
<pre><code class="java">@ControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity handleMethodArgumentNotValidException(HttpServletRequest req, MethodArgumentNotValidException e) {
        ...etc;
    }
}
</code></pre>
<ol>
  <li>@RequestBody 前面要加上 @Valid</li>
  <li>pojo (在此例指 User class) 要加上 validation annotation (e.g. @NotBlank, @NotNull ...etc)</li>
  <li>validate fail 會丟出 MethodArgumentNotValidException，要自己寫 handler 決定哪些異常明細回傳給前端</li>
</ol><h3>針對 @RequestParam 進行 validation</h3><p>實作程式碼重點如下</p>
<!--?prettify linenums=true?-->
<pre><code class="java">@Configuration
@ComponentScan
public class WebConfig {
    @Bean
    public MethodValidationPostProcessor methodValidationPostProcessor() {
        return new MethodValidationPostProcessor();
    }
}
</code></pre>
<!--?prettify linenums=true?-->
<pre><code class="java">@Validated
@RestController
@RequestMapping(&quot;/validateAnnotationDemo&quot;)
public class ValidateAnnotationDemoController {
    @RequestMapping(value = &quot;/validateRequestParam&quot;, produces = MediaType.APPLICATION_JSON_VALUE)
    public Map&lt;String,Object&gt; validateRequestParam(@NotBlank(message = &quot;message must not be blank&quot;) @RequestParam String message){
        ...etc;
    }
}
</code></pre>
<!--?prettify linenums=true?-->
<pre><code class="java">@ControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(ConstraintViolationException.class)
    public ResponseEntity handleConstraintViolationException(HttpServletRequest req, ConstraintViolationException e){
        ...etc;
    }
}
</code></pre>
<ol>
  <li>要注冊 MethodValidationPostProcessor bean，不然無法對 @RequestParam 進行 validation</li>
  <li>在 @RestController 前面加上 @Validated</li>
  <li>在 @RequestParam 前面加上 validation annotation (e.g. @NotBlank, @NotNull ...etc)</li>
  <li>validate fail 會丟出 ConstraintViolationException，要自己寫 handler 決定哪些異常明細回傳給前端</li>
</ol><h2>完整範例</h2><h3>WebConfig.java</h3>
<!--?prettify linenums=true?-->
<pre><code class="java">@Configuration
@ComponentScan
public class WebConfig {

    /**
     * 注冊 MethodValidationPostProcessor bean 之後，Controller class 開頭加的 @Validated 與 method 裡針
     * 對 @RequestParam annotation 加的 validate annotation (e.g. @NotBlank, @NotNull ...etc)才會生效，
     * 沒注冊時就算程式碼裡有加這些 annotation 還是不會有作用
     *
     * @return
     */
    @Bean
    public MethodValidationPostProcessor methodValidationPostProcessor() {
        return new MethodValidationPostProcessor();
    }
}
</code></pre><h3>ValidateAnnotationDemoController.java</h3>
<!--?prettify linenums=true?-->
<pre><code class="java">@Validated
@RestController
@RequestMapping(&quot;/validateAnnotationDemo&quot;)
public class ValidateAnnotationDemoController {

    //在 class 開頭加了 @Validated 之後，針對 @RequestParam 加的 validation annotation (e.g. @NotBlank, @NotNull...etc) 才會生效
    @RequestMapping(value = &quot;/validateRequestParam&quot;, produces = MediaType.APPLICATION_JSON_VALUE)
    public Map&lt;String,Object&gt; validateRequestParam(
            @NotBlank(message = &quot;message must not be blank&quot;) @RequestParam String message){
        Map&lt;String,Object&gt; result = new HashMap&lt;&gt;();
        result.put(&quot;message&quot;, message);
        return result;
    }

    // 加對 @Valid 之後，會驗証 pojo (此例中指 User instance) 內容格式是否正確
    @RequestMapping(value = &quot;/validateRequestBody&quot;, produces = MediaType.APPLICATION_JSON_VALUE)
    public User validateRequestBody(@Valid @RequestBody User user){
        return user;
    }

    private static class User{
        @NotBlank
        private String name;

        // 針對 list of pojo 的資料格式進行驗証，要加上 @NotEmpty, @Valid 二個 annotation
        @NotEmpty
        @Valid
        private List&lt;ContactInfo&gt; contactInfoList;

        public String getName() {
            return name;
        }

        public void setName(String name) {
            this.name = name;
        }

        public List&lt;ContactInfo&gt; getContactInfoList() {
            return contactInfoList;
        }

        public void setContactInfoList(List&lt;ContactInfo&gt; contactInfoList) {
            this.contactInfoList = contactInfoList;
        }
    }

    private static class ContactInfo{
        @NotBlank
        private String address;

        public String getAddress() {
            return address;
        }

        public void setAddress(String address) {
            this.address = address;
        }
    }
}
</code></pre><h3>GlobalExceptionHandler.java</h3>
<!--?prettify linenums=true?-->
<pre><code class="java">/**
 * Controller 發生 uncatch exception 情況時，會統一在這個 class 被處理。
 */
@ControllerAdvice
public class GlobalExceptionHandler {
    private static final Logger logger = LoggerFactory.getLogger(GlobalExceptionHandler.class);

    @ExceptionHandler(Exception.class)
    public ResponseEntity handleException(HttpServletRequest req, Exception e){
        logger.error(e.getMessage(), e);
        String errorMsg = (e.getMessage() == null) ? e.getClass().getSimpleName() : e.getMessage();
        Map&lt;String,Object&gt; error = Collections.singletonMap(&quot;error&quot;, errorMsg);
        return ResponseEntity.status(500).body(error);
    }

    /**
     * Controller 裡標注 @RequestParam 的變數在 validate fail 時會丟出 ConstraintViolationException。這個 method
     * 專門處理此類 exception
     *
     * @param req
     * @param e
     *
     * @return
     */
    @ExceptionHandler(ConstraintViolationException.class)
    public ResponseEntity handleConstraintViolationException(HttpServletRequest req, ConstraintViolationException e){
        logger.error(e.getMessage(), e);
        // &quot;@NotBlank @RequestParam String myArg&quot; 這樣的 validate 寫法在 validate fail 時無法得知 &quot;哪個輸入參數名稱&quot; 驗証失敗，這是 java reflection 本身的限制。
        // 用這類語法時要改寫成 &quot;@NotBlank(myArg must not be blank) @RequestParam String myArg&quot;，程式裡的 validate annotation 要寫出 &quot;完整出錯明細&quot;，
        // 不然在處理 ConstraintViolationException 時只會知道驗証失敗的原因，卻不知道是哪個輸入參數名稱驗証失敗。
        List&lt;String&gt; errorMessages = e.getConstraintViolations()
                .stream()
                .map(ConstraintViolation::getMessage)
                .collect(Collectors.toList());
        Map&lt;String,Object&gt; error = Collections.singletonMap(&quot;error&quot;, errorMessages);
        return ResponseEntity.status(400).body(error);
    }

    /**
     * Controller 裡標注 @RequestBody 的變數在 validate fail 時會丟出 MethodArgumentNotValidException。這個 method
     * 專門處理此類 exception
     *
     * @param req
     * @param e
     *
     * @return
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity handleMethodArgumentNotValidException(HttpServletRequest req, MethodArgumentNotValidException e) {
        logger.error(e.getMessage(), e);
        List&lt;String&gt; errorMessages = e.getBindingResult().getFieldErrors()
                .stream()
                .map(fieldError -&gt; fieldError.getField() + &quot; &quot; + fieldError.getDefaultMessage()) // 記錄 &quot;fieldName + validateFailMessage&quot;
                .collect(Collectors.toList());
        Map&lt;String,Object&gt; error = Collections.singletonMap(&quot;error&quot;, errorMessages);
        return ResponseEntity.status(400).body(error);
    }
}
</code></pre><h2>reference document</h2>
<ul>
  <li><a href="https://www.jianshu.com/p/51e8d2702ca1">在Spring MVC中使用註解的方式校驗RequestParams</a></li>
  <li><a href="https://sdqali.in/blog/2015/12/04/validating-requestparams-and-pathvariables-in-spring-mvc/">Validating RequestParams and PathVariables in Spring MVC</a></li>
  <li><a href="https://stackoverflow.com/a/38615327/8646444">Spring Boot REST @RequestParam not being Validated</a></li>
  <li><a href="https://stackoverflow.com/a/35588953/8646444">Spring MVC - @Valid on list of beans in REST service</a></li>
</ul></p>

      <hr />

      <!-- facebook like button -->
      <div class="fb-like" data-layout="button_count" data-action="like" data-show-faces="false" data-share="false" data-href="http://cloudtu.github.io/blog/2017/12/spring-restful-api-input-param-validate-memo.html"></div>

      <!-- facebook share button -->
      <div class="fb-share-button" data-layout="button_count" data-href="http://cloudtu.github.io/blog/2017/12/spring-restful-api-input-param-validate-memo.html"></div>

      <!-- Disqus comment plugin -->
      <div id="disqus_thread"></div>
      <script type="text/javascript" xml:space="preserve">
      //<![CDATA[
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//cloudtu.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      //]]>
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow" shape="rect">comments powered by Disqus.</a></noscript>

    </div>
  </div>
  <div>
      <div id="push"></div>

        <div id="footer">
          <div class="container">
            <p class="muted credit">&copy; <span>2017</span> CloudTu | Baked with <a href="http://jbake.org" shape="rect">JBake
              <span>v2.3.2</span></a></p>
          </div>
        </div>

        <!-- Le javascript
        ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script xml:space="preserve" src="/js/jquery-2.1.1.min.js"></script>
        <script xml:space="preserve" src="/js/bootstrap.min.js"></script>
        <script xml:space="preserve" src="/js/prettify.js"></script>

      </div>
    </body>
</html>
