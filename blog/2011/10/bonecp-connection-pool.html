<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
      <meta charset="utf-8" />
      <title>BoneCP Connection Pool 參數設置筆記</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <meta name="description" content="" />
      <meta name="author" content="cloudtu" />
      <meta name="keywords" content="" />

      <!-- Le styles -->
      <link rel="stylesheet" href="/css/bootstrap.min.css" />
      <link rel="stylesheet" href="/css/base.css" />
      <link rel="stylesheet" href="/css/prettify.css" />
  </head>
  <body onload="prettyPrint()">

  <!-- facebook script -->
  <div id="fb-root"></div>
  <script xml:space="preserve">
  //<![CDATA[
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v2.4";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
  //]]>
  </script>

  <div id="wrap">
    <div>

    <!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" shape="rect" href="/index.html">CloudTu's blog</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" shape="rect">Tags<b class="caret"></b></a>
              <ul class="dropdown-menu scrollable-menu">
                <li>
                  <a shape="rect" href="/tags/android.html">android</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/aws.html">aws</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/bitbucket.html">bitbucket</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/cassandra.html">cassandra</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/connection-pool.html">connection-pool</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/eclipse.html">eclipse</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/gae.html">gae</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/git.html">git</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/github.html">github</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/gradle.html">gradle</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/groovy.html">groovy</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/guava.html">guava</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/java.html">java</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/javascript.html">javascript</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/jax-rs.html">jax-rs</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/jbake.html">jbake</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/jersey.html">jersey</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/jetty.html">jetty</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/jquery.html">jquery</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/lambda.html">lambda</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/linux.html">linux</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/nexus7.html">nexus7</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/notepad-plus-plus.html">notepad-plus-plus</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/oauth2.html">oauth2</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/olap.html">olap</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/python.html">python</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/remote-control.html">remote-control</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/router.html">router</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/selenium.html">selenium</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/ssh.html">ssh</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/switch.html">switch</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/tomato.html">tomato</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/tomcat.html">tomcat</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/windows7.html">windows7</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/喔~鋼普拉.html">喔~鋼普拉</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/心情記事.html">心情記事</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/敗~敗家啦.html">敗~敗家啦</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/版控系統.html">版控系統</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/程式語言.html">程式語言</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/阿殺不魯.html">阿殺不魯</a>
                </li>
                <li>
                  <a shape="rect" href="/tags/電影、戲劇.html">電影、戲劇</a>
                </li>
              </ul>
            </li>
            <li><a shape="rect" href="/archive.html">Archive</a></li>
            <li><a shape="rect" href="/feed.xml">RSS</a></li>
            <li><a shape="rect" href="/about.html">About</a></li>
          </ul>

          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" shape="rect">Search<b class="caret"></b></a>
              <ul class="dropdown-menu google_search">
                <li>
                  <script xml:space="preserve">
                  //<![CDATA[
                    (function() {
                      var cx = '001738447238955852876:bkori8ynpby';
                      var gcse = document.createElement('script');
                      gcse.type = 'text/javascript';
                      gcse.async = true;
                      gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                          '//cse.google.com/cse.js?cx=' + cx;
                      var s = document.getElementsByTagName('script')[0];
                      s.parentNode.insertBefore(gcse, s);
                    })();
                  //]]>
                  </script>
                  <gcse:searchbox-only></gcse:searchbox-only>
                </li>
              </ul>
            </li>
          </ul>

        </div><!--/.nav-collapse -->
      </div>
    </div>

  </div>
    <div class="container">

      <div class="page-header">
        <h1>BoneCP Connection Pool 參數設置筆記</h1>
      </div>

      <p><em>2011-10-03</em></p>

      <p>
        <em>Tags:
          <span>
            <a shape="rect" href="../../../tags/connection-pool.html">connection-pool</a>
            <span>,</span>
          </span>
          <span>
            <a shape="rect" href="../../../tags/程式語言.html">程式語言</a>
            
          </span>
        </em>
      </p>

      <p>
這陣子因工作需要，必需寫一些對mySQL database頻繁存取的程式。理所當然的就一定會選用Connection Pool來加速DB連線的取得與管理。當時選用了DBCP與BoneCP兩種，下面是針對BoneCP設置的SampleCode與心得筆記。
<br>
<pre class="prettyprint">public class ConnectionManager {  <br> private static final BoneCPDataSource dataSource; <br> <br> static{<br>  try {<br>   Class.forName("com.mysql.jdbc.Driver");     <br>   dataSource = new BoneCPDataSource();<br>   dataSource.setJdbcUrl("dbConnectURL");<br>   dataSource.setUsername("dbUserName");<br>   dataSource.setPassword("dbPassword");<br>   dataSource.setPartitionCount(dbPoolPartitionCount); //connection pool的partition數量<br>   dataSource.setMaxConnectionsPerPartition(dbPoolMaxConnectionsPerPartition); //每個partition的最大連線數<br>   dataSource.setMinConnectionsPerPartition(dbPoolMinConnectionsPerPartition); //每個partition的最小連線數   <br>   dataSource.setIdleConnectionTestPeriodInMinutes(1); //檢查空閒連線的時間間隔<br>   dataSource.setConnectionTestStatement("SELECT 1");  //用來驗証連線是否還活著。MySQL用的語法是用"SELECT 1"，其它DB要設其它對應的語法；   <br>   dataSource.setIdleMaxAgeInMinutes(5); //空閒連線最大存活時間  <br>   dataSource.setConnectionTimeoutInMs(10000); //dataSource.getConnection()被呼叫時，超過多久時間未回應就回傳Timeout訊息<br>   //dataSource.setMaxConnectionAge(9, TimeUnit.MINUTES); //Sets the maxConnectionAge. Any connections older than this setting will be closed off whether it is idle or not.<br>                 //Connections currently in use will not be affected until they are returned to the pool.<br>                 //加入此項設定用來解決MySQL可能發生連線超時(SQLState = 08S01)的問題<br>   dataSource.setStatementsCacheSize(10);   <br>  }<br>  catch (Exception e) {<br>   throw new RuntimeException(e);<br>  }<br> }   <br>  <br>    public static synchronized Connection getConnection(){<br>        try {<br>            return dataSource.getConnection();<br>        }<br>        catch (Exception e) {<br>            throw new RuntimeException(e);<br>        }       <br>    }  <br>}<br></pre>
<br>心得筆記
<br>
<ol>
 <li>在mySQL裡執行"<code>show variables</code>"查詢，找出"<code>wait_timeout參數</code>"的設置時間(單位為秒)。Connection Pool的參數配置要配合此參數進行合適的調整，否則有時會出現遇想不到的問題。<br><br>之前遇到DB的參數值為"wait_timeout=600"時，Connection Pool常出現<code>Communications link failure</code>的問題。這問題的根源其實在於DB，DB端timeout時間很短，所以Connection Pool的參數裡，每個連線的存活時間要跟著調小，以免發生DB端已把連線斷掉，Connection Pool卻不知道，進而導致程式取到已被斷開的連線，然後程式發生連線異常的問題。&nbsp;</li>
 <li>BoneCP的JavaDoc API<a href="http://jolbox.com/bonecp/downloads/site/apidocs/index.html" target="_blank">在此</a>，可查相關的設定明細說明。</li>
 <li>SampleCode裡的<code>dataSource.setConnectionTestStatement(...)</code>、<code>dataSource.setIdleMaxAgeInMinutes(...)</code>、<code>dataSource.setMaxConnectionAge(...)</code>跟每種不同DB特性的關聯較大，要視使用何種DB做對應調整。</li>
 <li>DataSource本身並不是ThreadSafe，如果程式會開啟多個Thread同時取用連線，要加<code>synchronized</code>語法(如SampleCode所示)。</li>
 <li>
  <strike>
   目前如果遇到BoneCP取出的連線在執行資料存取時發生異常，會丟出
   <code>Database access problem. Killing off all remaining connections in the connection pool</code>訊息，然後整個Connection Pool就掛掉了，目前還找不到真正的原因為何...囧rz
   <br>
   <br>目前為避免此問題，使用
   <code>dataSource.setMaxConnectionAge(...)<code>強制設定</code></code>Connection Pool裡每個Connection(不管是idle還是正被使用中)的生命周期，讓它在短時間內(e.g. 10分鐘)就要消滅，必需再從DB重新取得。
  </strike></li>
</ol>updated 2011/10/31
<br>這儿天發現
<code>「Database access problem. Killing off all remaining connections in the connection pool」<code>問題的原因來自於程式本身的邏輯出錯，跟Connection Pool無關。當程式取出Connection後，完全不去用它，等到它超過Timeout的時間間隔後才去使用它，就有可能出現紅字的異常。一般的解決方式就是讓DAO功能的Class去綁定Connection，而不是BusineessObject去綁定Connection，進而達到Connection快速取得與釋放的目的。如果是寫WebApp，可以利用Filter來實作OpenSessionInView的機制，也可以達到同樣的效果，而且還省掉自己必需在程式碼中管理Connection取得與釋放的動作。</code></code>
<br>
<ol></ol>
</p>

      <hr />

      <!-- facebook like button -->
      <div class="fb-like" data-layout="button_count" data-action="like" data-show-faces="false" data-share="false" data-href="http://cloudtu.github.io/blog/2011/10/bonecp-connection-pool.html"></div>

      <!-- facebook share button -->
      <div class="fb-share-button" data-layout="button_count" data-href="http://cloudtu.github.io/blog/2011/10/bonecp-connection-pool.html"></div>

      <!-- Disqus comment plugin -->
      <div id="disqus_thread"></div>
      <script type="text/javascript" xml:space="preserve">
      //<![CDATA[
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//cloudtu.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      //]]>
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow" shape="rect">comments powered by Disqus.</a></noscript>

    </div>
  </div>
  <div>
      <div id="push"></div>

        <div id="footer">
          <div class="container">
            <p class="muted credit">&copy; <span>2015</span> CloudTu | Baked with <a href="http://jbake.org" shape="rect">JBake
              <span>v2.3.2</span></a></p>
          </div>
        </div>

        <!-- Le javascript
        ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script xml:space="preserve" src="/js/jquery-2.1.1.min.js"></script>
        <script xml:space="preserve" src="/js/bootstrap.min.js"></script>
        <script xml:space="preserve" src="/js/prettify.js"></script>

      </div>
    </body>
</html>
